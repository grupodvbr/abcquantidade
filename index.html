<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>ABC de Vendas ‚Ä¢ Mercatto</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
  :root{
    --bg:#f6f8fb; --card:#ffffff; --text:#0f172a; --muted:#6b7280; --line:#e5e7eb;
    --brand:#2563eb; --ok:#16a34a; --danger:#ef4444;
    --radius:16px; --shadow:0 12px 28px rgba(2,6,23,.06);
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;
    background:var(--bg); color:var(--text);}
  header{
    position:sticky; top:0; z-index:10;
    display:flex; align-items:center; justify-content:space-between;
    padding:14px 20px; background:#fff; border-bottom:1px solid var(--line);
  }
  header img{ height:56px; }
  header h1{ margin:0; font-size:1.4rem; font-weight:700; }
  .btn{ background:var(--brand); color:#fff; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; }
  .container{ padding:20px }
  .grid{ display:grid; gap:16px }
  .filters{ grid-template-columns:repeat(3, minmax(0,1fr)); }
  .lists{ grid-template-columns:repeat(2, minmax(0,1fr)); }
  @media (max-width:768px){.filters{grid-template-columns:1fr}.lists{grid-template-columns:1fr}}
  .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px }
  label{ font-weight:600; font-size:.9rem; margin-bottom:6px; display:block }
  input[type="date"],input[type="text"]{
    width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; font-size:.95rem
  }
  .section-title{ margin:18px 4px 10px; font-size:1rem; font-weight:700 }
  .item{ padding:10px 12px; border:1px dashed var(--line); border-radius:12px; margin-bottom:10px; background:#fff; cursor:pointer }
  .item:hover{ background:#f0f4ff }
  .loader{ display:flex; align-items:center; justify-content:center; gap:10px; padding:22px; color:var(--muted) }
  .spinner{ width:18px; height:18px; border:3px solid var(--line); border-top-color:var(--brand); border-radius:50%; animation:spin .8s linear infinite }
  @keyframes spin{ to{ transform:rotate(360deg) } }
  .alta{ color:var(--ok); font-weight:600; }
  .queda{ color:var(--danger); font-weight:600; }

  /* Modal */
  .modal{ display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.5); align-items:center; justify-content:center; z-index:50; }
  .modal-content{ 
    background:#fff; border-radius:16px; padding:20px; 
    width:95%; max-width:1400px; height:85vh; 
    display:grid; grid-template-columns:2.5fr 1fr; gap:20px; 
  }
  .modal-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  .close{ cursor:pointer; font-size:22px; font-weight:bold; }
  #graficoProduto{ width:100% !important; height:100% !important; }
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:16px">
    <img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true" alt="Grupo DV">
    <h1>ABC de Vendas ‚Ä¢ Mercatto</h1>
  </div>
  <button class="btn" onclick="atualizarAgora()">üîÑ Atualizar</button>
</header>

<div class="container">
  <!-- Filtros -->
  <div class="grid filters">
    <div class="card"><label>üîç Busca</label><input id="filtroBusca" type="text" placeholder="Produto..." /></div>
    <div class="card"><label>üìÖ In√≠cio</label><input id="dataInicio" type="date" /></div>
    <div class="card"><label>üìÖ Fim</label><input id="dataFim" type="date" /></div>
  </div>

  <!-- Cards -->
  <div class="section-title">An√°lises</div>
  <div class="grid lists">
    <div class="card"><h3>‚≠ê Top 10 Mais Vendidos</h3><div id="maisVendidos"></div></div>
    <div class="card"><h3>üìâ Top 10 Menos Vendidos</h3><div id="menosVendidos"></div></div>
    <div class="card"><h3>üìà Produtos em Alta</h3><div id="prodAlta"></div></div>
    <div class="card"><h3>üìâ Produtos em Queda</h3><div id="prodQueda"></div></div>
  </div>

  <!-- Lista geral -->
  <div class="section-title">Produtos Vendidos</div>
  <div class="card">
    <div id="statusBox" class="loader"><div class="spinner"></div> Carregando Mercatto‚Ä¶</div>
    <div id="listaVendas" style="display:none"></div>
  </div>
</div>

<!-- Modal -->
<div id="modalGrafico" class="modal">
  <div class="modal-content">
    <div>
      <div class="modal-header">
        <h3 id="tituloProduto">An√°lise de Produto</h3>
        <span class="close" onclick="fecharModal()">&times;</span>
      </div>
      <canvas id="graficoProduto"></canvas>
    </div>
    <div>
      <label>Comparar com outros produtos:</label>
      <select id="selectComparar" multiple="multiple" style="width:100%"></select>
      <button onclick="compararProduto()">Adicionar Selecionados</button>
    </div>
  </div>
</div>

<script>
const URL_SCRIPT="https://script.google.com/macros/s/AKfycbxu0HjXsbvXr9OGYDAEfN8Kqyle4d2GFb26wu8aAcAtfM-RkcILV9AywDjf1Fu8rW_NwQ/exec";
let CACHE=[], chartProd=null, PRODUTO_ATUAL=null;
const STORAGE_KEY="abc_mercatto_cache", EXPIRA_MS=6*60*60*1000;
const $$=sel=>document.querySelector(sel);

// meses formatados
const meses=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
function formatMes(ym){ const [y,m]=ym.split('-'); return meses[parseInt(m)-1]+'/'+y.slice(2); }

async function fetchMercatto(force=false){
  if(!force){
    try{
      const raw=localStorage.getItem(STORAGE_KEY);
      if(raw){
        const parsed=JSON.parse(raw);
        if(Date.now()-parsed.ts<EXPIRA_MS){
          console.log("‚ö° Dados carregados do localStorage");
          return parsed.data;
        }
      }
    }catch(e){ console.warn("Erro ao ler cache:",e); }
  }
  const res=await fetch(`${URL_SCRIPT}?empresa=MERCATTO`);
  const txt=await res.text(); let json;
  try{json=JSON.parse(txt);}catch(e){throw new Error("Resposta inv√°lida:\n"+txt);}
  const arr=Array.isArray(json)?json:(json.dados||[]);
  try{localStorage.setItem(STORAGE_KEY,JSON.stringify({data:arr,ts:Date.now()}));}catch(e){}
  return arr;
}
function setDatasMesAtual(){
  const hoje=new Date();
  const ano=hoje.getFullYear(), mes=hoje.getMonth();
  const inicio=new Date(ano,mes,1).toISOString().slice(0,10);
  const fim=new Date(ano,mes+1,0).toISOString().slice(0,10);
  $$('#dataInicio').value=inicio; $$('#dataFim').value=fim;
}
function aplicar(){
  const busca=($$('#filtroBusca').value||'').toLowerCase();
  const di=$$('#dataInicio').value, df=$$('#dataFim').value;
  let F=CACHE.filter(r=>{
    if(busca&&!String(r.produto||'').toLowerCase().includes(busca))return false;
    if(di&&r.data<di)return false; if(df&&r.data>df)return false; return true;
  });
  const byProd={};
  F.forEach(x=>{
    if(!byProd[x.produto])byProd[x.produto]={produto:x.produto,q:0,mes:{}};
    byProd[x.produto].q+=(x.quantidade||0);
    const [ano,mes]=x.data.split('-'); const chave=`${ano}-${mes}`;
    byProd[x.produto].mes[chave]=(byProd[x.produto].mes[chave]||0)+(x.quantidade||0);
  });
  const arr=Object.values(byProd).sort((a,b)=>b.q-a.q);
  renderLista('#maisVendidos',arr.slice(0,10));
  renderLista('#menosVendidos',arr.slice(-10));
  const hoje=new Date(); const ano=hoje.getFullYear();
  const mesAtual=String(hoje.getMonth()+1).padStart(2,'0');
  const mesAnterior=String(hoje.getMonth()).padStart(2,'0');
  const chaveAtual=`${ano}-${mesAtual}`, chaveAnterior=`${ano}-${mesAnterior}`;
  const alta=[], queda=[];
  arr.forEach(p=>{
    const atual=p.mes[chaveAtual]||0, anterior=p.mes[chaveAnterior]||0;
    if(anterior>0){
      const variacao=((atual-anterior)/anterior)*100;
      if(variacao>0) alta.push({produto:p.produto,q:atual,perc:variacao});
      if(variacao<0) queda.push({produto:p.produto,q:atual,perc:variacao});
    }
  });
  renderLista('#prodAlta',alta.sort((a,b)=>b.perc-a.perc).slice(0,10),true);
  renderLista('#prodQueda',queda.sort((a,b)=>a.perc-b.perc).slice(0,10),true);
  const cont=$$('#listaVendas'); cont.innerHTML='';
  arr.forEach(p=>{
    const div=document.createElement('div'); div.className='item';
    div.textContent=`${p.produto} ‚Äî ${p.q.toLocaleString()} un`;
    div.onclick=()=>mostrarGrafico(p);
    cont.appendChild(div);
  });
  $$('#statusBox').style.display=arr.length?'none':'block';
  $$('#listaVendas').style.display=arr.length?'block':'none';
}
function renderLista(sel,arr,perc=false){
  const el=$$(sel);
  el.innerHTML=arr.map(p=>{
    if(perc){
      const classe=p.perc>0?'alta':'queda';
      const seta=p.perc>0?'‚¨ÜÔ∏è':'‚¨áÔ∏è';
      return `<div class="item ${classe}">${p.produto} ‚Äî ${p.q.toLocaleString()} un (${seta} ${p.perc.toFixed(1)}%)</div>`;
    }
    return `<div class="item">${p.produto} ‚Äî ${p.q.toLocaleString()} un</div>`;
  }).join('')||'<div class="muted">‚Äî</div>';
}
function mostrarGrafico(prod){
  PRODUTO_ATUAL=prod;
  const allMeses=[...new Set(CACHE.map(r=>{const [ano,mes]=r.data.split('-');return `${ano}-${mes}`;}))].sort();
  const canvas=$$('#graficoProduto'); if(chartProd)chartProd.destroy();
  const vals=allMeses.map(m=>prod.mes[m]||0);
  chartProd=new Chart(canvas.getContext('2d'),{
    type:'line',
    data:{labels:allMeses.map(formatMes),datasets:[{label:prod.produto,data:vals,borderColor:'#2563eb',pointRadius:5,pointHoverRadius:7,fill:false}]},
    options:{responsive:true,interaction:{mode:'index',intersect:false},
      plugins:{legend:{display:true},tooltip:{callbacks:{label:ctx=>ctx.dataset.label+': '+(ctx.parsed.y||0).toLocaleString('pt-BR')+' un'}}},
      scales:{x:{title:{display:true,text:"Meses"},ticks:{autoSkip:false,maxRotation:45,minRotation:45}},y:{beginAtZero:true,title:{display:true,text:"Quantidade"}}}
    }
  });
  $$('#tituloProduto').textContent=prod.produto;
  const sel=$('#selectComparar'); sel.empty();
  const nomes=[...new Set(CACHE.map(x=>x.produto).filter(n=>n&&n!==prod.produto))].sort();
  nomes.forEach(nome=>sel.append(new Option(nome,nome)));
  sel.select2({placeholder:"Digite para buscar produtos...",allowClear:true});
  $$('#modalGrafico').style.display='flex';
}
function fecharModal(){ $$('#modalGrafico').style.display='none'; }
function compararProduto(){
  const nomes=$('#selectComparar').val(); if(!nomes||!nomes.length)return;
  const allMeses=[...new Set(CACHE.map(r=>{const [ano,mes]=r.data.split('-');return `${ano}-${mes}`;}))].sort();
  const labels=allMeses.map(formatMes);
  nomes.forEach(nome=>{
    if(chartProd.data.datasets.some(ds=>ds.label===nome))return;
    const prod=CACHE.filter(r=>r.produto===nome); if(!prod.length)return;
    const byMes={}; prod.forEach(x=>{const [ano,mes]=x.data.split('-');const chave=`${ano}-${mes}`;byMes[chave]=(byMes[chave]||0)+(x.quantidade||0);});
    const vals=allMeses.map(m=>byMes[m]||0);
    chartProd.data.datasets.push({label:nome,data:vals,borderColor:'#'+Math.floor(Math.random()*16777215).toString(16),pointRadius:5,pointHoverRadius:7,fill:false});
  });
  chartProd.update();
}
async function boot(force=false){
  try{const arr=await fetchMercatto(force);CACHE=arr;setDatasMesAtual();aplicar();}
  catch(e){$$('#statusBox').textContent='Erro ao carregar: '+(e.message||e);}
}
function atualizarAgora(){localStorage.removeItem(STORAGE_KEY);boot(true);}
window.addEventListener('load',()=>{
  boot();
  ['input','change'].forEach(evt=>{
    $$('#filtroBusca').addEventListener(evt,aplicar);
    $$('#dataInicio').addEventListener(evt,aplicar);
    $$('#dataFim').addEventListener(evt,aplicar);
  });
});
</script>
</body>
</html>
